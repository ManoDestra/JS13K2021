<html lang="EN">
	<head>
		<title>MIDI Test</title>
		<meta charset="UTF-8" />
		<style>
			body {
				background-color: darkred;
				color: white;
				font-family: Segoe UI,sans-serif;
				font-size: 1.2em;
			}
		</style>
	</head>
	<body>
		<button onclick="play();">Play</button>
		<script>
			class Midi {
				#inputs;
				#outputs;

				constructor() {
				}

				async init() {
					const { inputs, outputs } = await this.#init();
					this.#inputs = inputs;
					this.#outputs = outputs;
				}

				getInputs() {
					return this.#inputs;
				}

				getOutputs() {
					return this.#outputs;
				}

				#init() {
					if (!navigator?.requestMIDIAccess) {
						throw new Error('MIDI Is Not Supported By This Browser');
					}

					return navigator.requestMIDIAccess();
				}
			}

			const events = [];

			async function play() {
				const midi = new Midi();
				await midi.init();
				const output = midi.getOutputs().get('output-1');
				for (let event of events) {
					output.send(event.data, performance.now() + event.timestamp);
				}
			}

			(async () => {
				function onMidiMessage(e) {
					const data = e.data;
					if (data[0] != 248 && data[0] != 254) {
						const timestamp = performance.now();
						console.log(data, timestamp);
						events.push({
							data,
							timestamp
						});
					}
				}

				try {
					const midi = new Midi();
					await midi.init();

					const input = midi.getInputs().get('input-0');
					console.log(input);
					input.onmidimessage = onMidiMessage;

					const output = midi.getOutputs().get('output-1');
					console.log(output);

					const loop = [
						40, 38, 33, 36, 33,
						40, 38, 33, 36, 38,
						40, 38, 33, 36, 33,
						40, 38, 33, 36, 38, 33
					];
					const array = [
						...loop,
						...loop,
						//...loop,
						//...loop
					];
					const NOTE_ON_1 = 144;
					const NOTE_ON_9 = 153;
					const NOTE_ON_10 = 154;
					const start = performance.now();
					const volume = 48;
					const delay = 220;
					for (let i = 0; i < array.length; i++) {
						//output.send([NOTE_ON_1, array[i], volume], start + (i * delay));
						//output.send([NOTE_ON_1, array[i], 0], start + ((i + 1) * delay));
					}
				} catch(e) {
					console.error(e);
				}
			})();

			/*
			(async () => {
				function onMidiMessage(e) {
					const data = e.data;
					if (data[0] != 248 && data[0] != 254) {
						console.log(data);
					}
				}

				try {
					const {inputs, outputs} = await Midi.init();
					console.log(inputs);
					console.log(outputs);
					console.log('Inputs');
					for (let i of inputs.entries()) {
						console.log(i);
					}

					console.log('Outputs');
					for (let o of outputs.entries()) {
						console.log(o);
					}

					inputs.forEach(i => {
						i.onmidimessage = onMidiMessage;
					});

					const output = outputs.get('output-1');
					console.log(output);
					const array = [
						40, 38, 33, 36, 33,
						40, 38, 33, 36, 38,
						40, 38, 33, 36, 33,
						40, 38, 33, 36, 38, 33
					];
					const NOTE_ON = 144;
					const start = performance.now();
					const volume = 48;
					const delay = 220;
					for (let i = 0; i < array.length; i++) {
						output.send([NOTE_ON, array[i], volume], start + (i * delay));
						output.send([NOTE_ON, array[i], 0], start + ((i + 1) * delay));
					}
				} catch(e) {
					console.error(e);
				}
			})();
			*/
		</script>
	</body>
</html>
